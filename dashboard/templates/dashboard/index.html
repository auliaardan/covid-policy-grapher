<!doctype html>
<html lang="en">
<head>
    <meta charset="utf-8"/>
    <meta name="viewport" content="width=device-width, initial-scale=1"/>
    <title>COVID Policy + Outcomes Simulator</title>
    <script src="https://cdn.jsdelivr.net/npm/echarts@5/dist/echarts.min.js"></script>
    <style>
        :root {
            --bg: #0b1020;
            --card: rgba(255, 255, 255, 0.06);
            --card-border: rgba(255, 255, 255, 0.12);
            --text: #e8ecff;
            --muted: rgba(232, 236, 255, 0.75);
            --pill: rgba(255, 255, 255, 0.10);
        }

        body {
            margin: 0;
            font-family: system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, sans-serif;
            background: radial-gradient(1200px 800px at 20% 0%, #141b3d 0%, var(--bg) 60%);
            color: var(--text);
        }

        .wrap {
            max-width: 1200px;
            margin: 0 auto;
            padding: 18px;
        }

        .topbar {
            display: flex;
            flex-wrap: wrap;
            gap: 12px;
            align-items: center;
        }

        .row {
            display: flex;
            gap: 10px;
            align-items: center;
            flex-wrap: wrap;
        }

        h1 {
            font-size: 18px;
            margin: 0 0 10px 0;
            letter-spacing: 0.2px;
        }

        .pill {
            display: inline-flex;
            padding: 6px 10px;
            border-radius: 999px;
            background: var(--pill);
            border: 1px solid rgba(255, 255, 255, 0.14);
            font-size: 12px;
            color: var(--text);
        }

        select {
            /* Force readable dropdown text on mobile */
            background: #ffffff;
            color: #000000;
            border: 1px solid rgba(0, 0, 0, 0.22);
            padding: 10px 12px;
            border-radius: 12px;
            outline: none;
        }

        button, input[type="range"] {
            background: rgba(255, 255, 255, 0.10);
            color: #e8ecff;
            border: 1px solid rgba(255, 255, 255, 0.18);
            padding: 10px 12px;
            border-radius: 12px;
            outline: none;
        }

        /* Make native dropdown options readable (esp. Android) */
        select option, select optgroup {
            background: #ffffff;
            color: #000000;
        }

        button { cursor: pointer; }

        .grid {
            display: grid;
            grid-template-columns: 2fr 1fr;
            gap: 14px;
            margin-top: 14px;
        }

        .card {
            background: var(--card);
            border: 1px solid var(--card-border);
            border-radius: 14px;
            padding: 12px;
        }

        #chart { height: 520px; }

        .mini { font-size: 12px; opacity: 0.8; }

        .muted-btn { opacity: 0.85; }

        .section-title {
            display: flex;
            align-items: baseline;
            justify-content: space-between;
            margin-bottom: 8px;
        }

        .event-card {
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid rgba(255, 255, 255, 0.10);
            border-radius: 12px;
            padding: 10px;
            margin-bottom: 10px;
        }

        .event-date { font-weight: 600; margin-bottom: 6px; }

        .event-item { margin: 4px 0; }

        .kbd {
            font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, monospace;
            font-size: 12px;
            padding: 2px 6px;
            border-radius: 8px;
            background: rgba(255, 255, 255, 0.10);
            border: 1px solid rgba(255, 255, 255, 0.16);
        }

        /* Highlight modal */
        .backdrop {
            position: fixed;
            inset: 0;
            background: rgba(0,0,0,0.55);
            display: none;
            align-items: center;
            justify-content: center;
            padding: 16px;
            z-index: 50;
        }

        .modal {
            width: min(720px, 100%);
            background: #0f1730;
            border: 1px solid rgba(255,255,255,0.18);
            border-radius: 16px;
            padding: 14px;
            box-shadow: 0 14px 40px rgba(0,0,0,0.45);
        }

        .modal-head {
            display: flex;
            justify-content: space-between;
            align-items: center;
            gap: 10px;
        }

        .modal-head h2 {
            margin: 0;
            font-size: 16px;
        }

        .xbtn {
            background: rgba(255,255,255,0.10);
            border: 1px solid rgba(255,255,255,0.16);
            border-radius: 10px;
            padding: 8px 10px;
        }

        ul.list { margin: 8px 0 0 18px; padding: 0; }
        ul.list li { margin: 4px 0; }

        @media (max-width: 980px) {
            .grid { grid-template-columns: 1fr; }
            #chart { height: 440px; }
        }

        @media (max-width: 600px) {
            .wrap { padding: 12px; }
            .topbar { gap: 10px; }
            .topbar .row { width: 100%; }
            #countrySelect, #speedSelect, #btnNextHighlight { width: 100%; }
            select, button, input[type="range"] {
                font-size: 16px;
                padding: 12px 14px;
                border-radius: 14px;
            }
            #chart { height: 360px; }
        }
    </style>
</head>
<body>
<div class="wrap">
    <h1>COVID Policy + Outcomes Explorer (Interactive)</h1>

    <div class="topbar">
        <div class="row">
            <span class="pill">Country</span>
            <select id="countrySelect"></select>

            <span class="pill">Speed</span>
            <select id="speedSelect">
                <option value="1">1√ó</option>
                <option value="2">2√ó</option>
                <option value="5">5√ó</option>
                <option value="10" selected>10√ó</option>
                <option value="30">30√ó</option>
            </select>
        </div>

        <div class="row">
            <button id="btnPlay">Play</button>
            <button class="muted-btn" id="btnReset">Reset</button>

            <label class="mini" style="display:flex; align-items:center; gap:8px;">
                <input id="showVax" type="checkbox" checked/>
                Show vaccination (% fully)
            </label>

            <label class="mini" style="display:flex; align-items:center; gap:8px;">
                <input id="autoPause" type="checkbox" checked/>
                Auto-pause on highlights
            </label>
            <button class="muted-btn" id="btnNextHighlight">Next highlight</button>
        </div>

        <div class="row" style="flex: 1; min-width: 260px;">
            <span class="pill" id="dateLabel">‚Äî</span>
            <input id="dateSlider" type="range" min="0" max="0" value="0" style="width: 100%;"/>
        </div>
    </div>

    <div class="grid">
        <div class="card">
            <div class="section-title">
                <div>Chart</div>
                <div class="mini">Hover for policy levels + vaccination</div>
            </div>
            <div id="chart"></div>
            <div class="mini" style="margin-top: 10px;">
                Tip: Use <span class="kbd">Next highlight</span> to jump to major policy shifts, acceleration, or vaccination milestones.
            </div>
        </div>

        <div class="card events">
            <div class="section-title">
                <div>Events & Policy Context</div>
                <div class="mini">Auto-generated from policy diffs</div>
            </div>

            <div class="pill" id="policyBadge">‚Äî</div>
            <div id="policyStatus" class="mini" style="margin-top: 10px; line-height: 1.45;"></div>

            <div class="section-title" style="margin-top: 12px;">
                <div>Policy-change cards</div>
                <div class="mini">for the selected date</div>
            </div>
            <div id="eventsContainer" style="margin-top: 10px;"></div>

            <hr style="border:0; border-top:1px solid rgba(255,255,255,0.12); margin:14px 0;">

            <div class="section-title">
                <div>Sources</div>
            </div>

            <ol class="mini" style="padding-left: 18px; margin: 8px 0 0 0; line-height: 1.45;">
                <li>
                    Hale T, Angrist N, Goldszmidt R, et al. A global panel database of pandemic policies (Oxford
                    COVID-19 Government Response Tracker).
                    <i>Nat Hum Behav</i>. 2021;5:529‚Äì538. doi:10.1038/s41562-021-01079-8.
                </li>
                <li>
                    Oxford COVID-19 Government Response Tracker. Calculation and presentation of the Stringency Index
                    4.0 [Internet].
                    Oxford: Blavatnik School of Government, University of Oxford; 2020 Apr 28 [cited 2026 Jan 31].
                    Available from:
                    <a href="https://www.bsg.ox.ac.uk/sites/default/files/Calculation%20and%20presentation%20of%20the%20Stringency%20Index.pdf"
                       target="_blank" rel="noopener">
                        https://www.bsg.ox.ac.uk/sites/default/files/Calculation%20and%20presentation%20of%20the%20Stringency%20Index.pdf
                    </a>
                </li>
                <li>
                    Our World in Data. Data on COVID-19 (coronavirus) by Our World in Data: dataset documentation [Internet].
                    Oxford: Our World in Data; [cited 2026 Jan 31].
                    Available from:
                    <a href="https://docs.owid.io/projects/covid/en/latest/dataset.html" target="_blank" rel="noopener">
                        https://docs.owid.io/projects/covid/en/latest/dataset.html
                    </a>
                </li>
                <li>
                    Our World in Data. COVID-19 dataset (owid-covid-data.csv) [Internet].
                    Oxford: Our World in Data; [cited 2026 Jan 31].
                    Available from:
                    <a href="https://github.com/owid/covid-19-data/tree/master/public/data" target="_blank" rel="noopener">
                        https://github.com/owid/covid-19-data/tree/master/public/data
                    </a>
                </li>
            </ol>
        </div>
    </div>
</div>

<div class="backdrop" id="highlightBackdrop">
    <div class="modal">
        <div class="modal-head">
            <div>
                <h2 id="hlTitle">Highlight</h2>
                <div class="mini" id="hlDate">‚Äî</div>
            </div>
            <button class="xbtn" id="hlClose">Close</button>
        </div>
        <div id="hlBody" class="mini" style="margin-top:10px; line-height:1.5;"></div>
    </div>
</div>

<script>
    const state = {
        dates: [],
        series: {},
        meta: {policy_levels: {}, policy_labels: {}, stringency_explainer: ""},
        eventsByDate: new Map(),      // date -> [text...]
        highlightsByDate: new Map(),  // date -> [highlight objects]
        shownHighlights: new Set(),
        idx: 0,
        playing: false,
        timer: null,
    };

    const chart = echarts.init(document.getElementById("chart"));

    function escapeHtml(s) {
        return String(s).replaceAll("&", "&amp;").replaceAll("<", "&lt;")
            .replaceAll(">", "&gt;").replaceAll('"', "&quot;").replaceAll("'", "&#039;");
    }

    async function loadCountries() {
        const res = await fetch("/api/countries/");
        const data = await res.json();
        const sel = document.getElementById("countrySelect");
        sel.innerHTML = "";

        const countries = data.countries || [];
        countries.sort((a, b) => {
            if (a.iso_code === "IDN") return -1;
            if (b.iso_code === "IDN") return 1;
            return a.name.localeCompare(b.name);
        });

        for (const c of countries) {
            const opt = document.createElement("option");
            opt.value = c.iso_code;
            opt.textContent = `${c.name} (${c.iso_code})`;
            sel.appendChild(opt);
        }

        sel.value = countries.find(x => x.iso_code === "IDN") ? "IDN" : (countries[0]?.iso_code || "");
    }

    async function loadSeries(iso) {
        setPlaying(false);
        const res = await fetch(`/api/timeseries/${encodeURIComponent(iso)}/`);
        const data = await res.json();

        state.dates = data.dates || [];
        state.series = data.series || {};
        state.meta = data.meta || {policy_levels: {}, policy_labels: {}, stringency_explainer: ""};

        state.eventsByDate = new Map();
        for (const ev of (data.events || [])) {
            state.eventsByDate.set(ev.date, ev.items || []);
        }

        state.highlightsByDate = new Map();
        for (const h of (data.highlights || [])) {
            if (!state.highlightsByDate.has(h.date)) state.highlightsByDate.set(h.date, []);
            state.highlightsByDate.get(h.date).push(h);
        }

        state.shownHighlights = new Set();
        state.idx = state.dates.length ? state.dates.length - 1 : 0;

        const slider = document.getElementById("dateSlider");
        slider.min = "0";
        slider.max = String(Math.max(0, state.dates.length - 1));
        slider.value = String(state.idx);

        renderFrame(false);
    }

    function policyLevelText(key, val) {
        if (val === null || val === undefined) return "‚Äî";
        const levels = (state.meta.policy_levels || {})[key] || null;
        if (!levels) return String(val);
        const desc = levels[String(val)] ?? levels[val] ?? "Level";
        return `${val} (${desc})`;
    }

    function renderPolicyStatus() {
        const s = state.series;
        const i = state.idx;
        const labels = state.meta.policy_labels || {};
        const badge = document.getElementById("policyBadge");
        const box = document.getElementById("policyStatus");

        const st = s.stringency?.[i];
        badge.textContent = (st !== null && st !== undefined) ? `Stringency: ${Number(st).toFixed(1)}` : "‚Äî";

        const lines = [];
        lines.push(`<div><b>Stringency</b>: ${(st !== null && st !== undefined) ? Number(st).toFixed(1) : "‚Äî"}</div>`);
        lines.push(`<div class="mini" style="margin-top:6px;">${escapeHtml(state.meta.stringency_explainer || "")}</div>`);
        lines.push(`<hr style="border:0; border-top:1px solid rgba(255,255,255,0.10); margin:10px 0;">`);

        const items = [
            ["c1_school_closing", s.school?.[i]],
            ["c2_workplace_closing", s.work?.[i]],
            ["c6_stay_at_home", s.stayhome?.[i]],
            ["c8_international_travel_controls", s.travel?.[i]],
            ["h6_facial_coverings", s.masks?.[i]],
        ];

        for (const [k, v] of items) {
            lines.push(`<div><b>${escapeHtml(labels[k] || k)}</b>: ${escapeHtml(policyLevelText(k, v))}</div>`);
        }

        box.innerHTML = lines.join("");
    }

    function renderEvents(dateStr) {
        const box = document.getElementById("eventsContainer");
        box.innerHTML = "";

        const items = state.eventsByDate.get(dateStr) || [];
        if (!items.length) {
            box.innerHTML = `<div class="mini">No policy-change card on this date.</div>`;
            return;
        }

        const card = document.createElement("div");
        card.className = "event-card";
        card.innerHTML = `<div class="event-date">${dateStr}</div>` + items.map(x => `<div class="event-item">‚Ä¢ ${escapeHtml(x)}</div>`).join("");
        box.appendChild(card);
    }

    function buildOption() {
        const d = state.dates;
        const s = state.series;
        const showVax = (document.getElementById("showVax")?.checked ?? true);

        const yAxes = [
            { type: "value", axisLabel: { color: "#c9d2ff" }, name: "Cases/Deaths" },
            { type: "value", axisLabel: { color: "#c9d2ff" }, name: "Policy", min: 0, max: 100 },
        ];

        const series = [
            { name: "Cases (7d avg)", type: "line", yAxisIndex: 0, showSymbol: false, data: s.cases || [] },
            { name: "Deaths (7d avg)", type: "line", yAxisIndex: 0, showSymbol: false, data: s.deaths || [] },
            { name: "Stringency", type: "line", yAxisIndex: 1, showSymbol: false, data: s.stringency || [] },
        ];

        if (showVax) {
            yAxes.push({ type: "value", axisLabel: { color: "#c9d2ff" }, name: "Vaccination (%)", min: 0, max: 100 });
            series.push({
                name: "Fully vaccinated (%)",
                type: "line",
                yAxisIndex: 2,
                showSymbol: false,
                data: s.vax_full || [],
            });
        }

        return {
            animation: false,
            tooltip: {
                trigger: "axis",
                formatter: (params) => {
                    const idx = params?.[0]?.dataIndex ?? state.idx;
                    const dateStr = d[idx] || "‚Äî";
                    const cases = s.cases?.[idx];
                    const deaths = s.deaths?.[idx];
                    const st = s.stringency?.[idx];
                    const vax = s.vax_full?.[idx];

                    const lines = [];
                    lines.push(`<b>${escapeHtml(dateStr)}</b>`);
                    lines.push(`Cases (7d avg): <b>${cases ?? "‚Äî"}</b>`);
                    lines.push(`Deaths (7d avg): <b>${deaths ?? "‚Äî"}</b>`);
                    lines.push(`Stringency: <b>${(st !== null && st !== undefined) ? Number(st).toFixed(1) : "‚Äî"}</b>`);
                    if (showVax) lines.push(`Fully vaccinated (%): <b>${(vax !== null && vax !== undefined) ? Number(vax).toFixed(1) : "‚Äî"}</b>`);

                    lines.push(`<div style="margin-top:6px; opacity:.9;"><b>Policy levels</b></div>`);
                    lines.push(`School closing: ${escapeHtml(policyLevelText("c1_school_closing", s.school?.[idx]))}`);
                    lines.push(`Stay-at-home: ${escapeHtml(policyLevelText("c6_stay_at_home", s.stayhome?.[idx]))}`);
                    lines.push(`Intl travel: ${escapeHtml(policyLevelText("c8_international_travel_controls", s.travel?.[idx]))}`);
                    lines.push(`Face coverings: ${escapeHtml(policyLevelText("h6_facial_coverings", s.masks?.[idx]))}`);

                    return lines.join("<br/>");
                }
            },
            legend: { textStyle: { color: "#e8ecff" } },
            grid: { left: 50, right: 20, top: 35, bottom: 40 },
            xAxis: {
                type: "category",
                data: d,
                axisLabel: { color: "#c9d2ff", formatter: (v) => String(v).slice(0, 10) }
            },
            yAxis: yAxes,
            series: series
        };
    }

    function renderFrame(fromPlayback = false) {
        const d = state.dates[state.idx];
        document.getElementById("dateLabel").textContent = d || "‚Äî";

        const opt = buildOption();
        opt.series.forEach(s => {
            if (s.type === "line" && (
                s.name === "Cases (7d avg)" ||
                s.name === "Stringency" ||
                s.name === "Fully vaccinated (%)"
            )) {
                s.markLine = { symbol: ["none", "none"], data: [{ xAxis: d }] };
            }
        });
        chart.setOption(opt, true);

        renderEvents(d);
        renderPolicyStatus(d);

        const autoPause = document.getElementById("autoPause").checked;
        if (fromPlayback && state.playing && autoPause) {
            const highlights = state.highlightsByDate.get(d) || [];
            if (highlights.length) {
                const key = d + "::" + highlights.map(h => h.type + h.title).join("|");
                if (!state.shownHighlights.has(key)) {
                    state.shownHighlights.add(key);
                    setPlaying(false);
                    showHighlightModal(d, highlights);
                }
            }
        }
    }

    function nextIdx(step = 1) {
        return Math.min(state.dates.length - 1, Math.max(0, state.idx + step));
    }

    function tick() {
        if (!state.playing) return;

        const speed = Number(document.getElementById("speedSelect").value || "10");
        const step = Math.max(1, Math.round(speed / 10));
        const nxt = nextIdx(step);

        if (nxt === state.idx) {
            setPlaying(false);
            return;
        }

        state.idx = nxt;
        document.getElementById("dateSlider").value = String(state.idx);
        renderFrame(true);
    }

    function setPlaying(on) {
        state.playing = on;
        document.getElementById("btnPlay").textContent = on ? "Pause" : "Play";
        if (state.timer) clearInterval(state.timer);
        state.timer = on ? setInterval(tick, 220) : null;
    }

    function showHighlightModal(dateStr, highlights) {
        const backdrop = document.getElementById("highlightBackdrop");
        document.getElementById("hlDate").textContent = dateStr;
        document.getElementById("hlTitle").textContent = (highlights?.length || 0) > 1 ? "Highlights" : "Highlight";

        const parts = [];
        for (const h of (highlights || [])) {
            const icon =
                h.type === "policy" ? "üìú" :
                    (h.type === "cases" ? "üìà" :
                        (h.type === "deaths" ? "‚ö†Ô∏è" :
                            (h.type === "vax" ? "üíâ" : "‚≠ê")));
            parts.push(
                `<div style="margin-bottom:10px;">
                    <b>${icon} ${escapeHtml(h.title || "")}</b>
                    ${h.details && h.details.length ? `<ul class="list">${h.details.map(x => `<li>${escapeHtml(x)}</li>`).join("")}</ul>` : ""}
                 </div>`
            );
        }
        document.getElementById("hlBody").innerHTML = parts.join("");

        backdrop.style.display = "flex";
    }

    function closeHighlightModal() {
        document.getElementById("highlightBackdrop").style.display = "none";
    }

    function jumpToNextHighlight() {
        const start = state.idx + 1;
        for (let i = start; i < state.dates.length; i++) {
            const d = state.dates[i];
            if ((state.highlightsByDate.get(d) || []).length) {
                state.idx = i;
                document.getElementById("dateSlider").value = String(state.idx);
                renderFrame(false);
                showHighlightModal(d, state.highlightsByDate.get(d) || []);
                return;
            }
        }
    }

    // --- Wire UI ---
    document.getElementById("btnPlay").addEventListener("click", () => setPlaying(!state.playing));
    document.getElementById("btnReset").addEventListener("click", () => {
        state.idx = 0;
        document.getElementById("dateSlider").value = "0";
        renderFrame(false);
    });

    document.getElementById("countrySelect").addEventListener("change", async (e) => {
        await loadSeries(e.target.value);
    });

    document.getElementById("dateSlider").addEventListener("input", (e) => {
        state.idx = Number(e.target.value);
        renderFrame(false);
    });

    document.getElementById("btnNextHighlight").addEventListener("click", () => jumpToNextHighlight());
    document.getElementById("hlClose").addEventListener("click", () => closeHighlightModal());
    document.getElementById("highlightBackdrop").addEventListener("click", (e) => {
        if (e.target.id === "highlightBackdrop") closeHighlightModal();
    });

    document.getElementById("showVax").addEventListener("change", () => renderFrame(false));

    // Init
    (async function init() {
        await loadCountries();
        const iso = document.getElementById("countrySelect").value;
        await loadSeries(iso);
    })();
</script>
</body>
</html>
