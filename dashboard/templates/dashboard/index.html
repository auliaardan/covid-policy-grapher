<!doctype html>
<html>
<head>
    <meta charset="utf-8"/>
    <meta name="viewport" content="width=device-width,initial-scale=1"/>
    <title>COVID Policy Timeline Simulator</title>
    <script src="https://cdn.jsdelivr.net/npm/echarts@5/dist/echarts.min.js"></script>
    <style>
        body {
            font-family: system-ui, Arial, sans-serif;
            margin: 0;
            background: #0b1020;
            color: #e8ecff;
        }

        .card.events a {
            color: #c9d2ff;
        }

        .card.events a:hover {
            opacity: 0.9;
        }

        .wrap {
            max-width: 1200px;
            margin: 0 auto;
            padding: 16px;
        }

        .topbar {
            display: flex;
            flex-wrap: wrap;
            gap: 12px;
            align-items: center;
            padding: 12px;
            background: rgba(255, 255, 255, 0.06);
            border-radius: 14px;
        }

        select, button, input[type="range"] {
            background: rgba(255, 255, 255, 0.10);
            color: #e8ecff;
            border: 1px solid rgba(255, 255, 255, 0.18);
            padding: 10px 12px;
            border-radius: 12px;
            outline: none;
        }

        /* Make native dropdown options readable (esp. Android) */
        select option, select optgroup {
            background: #ffffff;
            color: #000000;
        }

        button {
            cursor: pointer;
        }

        .grid {
            display: grid;
            grid-template-columns: 2fr 1fr;
            gap: 14px;
            margin-top: 14px;
        }

        .card {
            background: rgba(255, 255, 255, 0.06);
            border: 1px solid rgba(255, 255, 255, 0.12);
            border-radius: 14px;
            padding: 12px;
        }

        #chart {
            height: 520px;
        }

        .mini {
            font-size: 12px;
            opacity: 0.8;
        }

        .row {
            display: flex;
            gap: 10px;
            align-items: center;
            flex-wrap: wrap;
        }

        .pill {
            padding: 6px 10px;
            border-radius: 999px;
            background: rgba(255, 255, 255, 0.10);
            border: 1px solid rgba(255, 255, 255, 0.16);
        }

        .events {
            max-height: 520px;
            overflow: auto;
        }

        .event-card {
            padding: 10px;
            border-radius: 12px;
            background: rgba(0, 0, 0, 0.25);
            border: 1px solid rgba(255, 255, 255, 0.10);
            margin-bottom: 10px;
        }

        .event-date {
            font-weight: 700;
            margin-bottom: 6px;
        }

        .event-item {
            margin: 4px 0;
            font-size: 13px;
        }

        .section-title {
            font-weight: 800;
            margin: 6px 0 8px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .muted-btn {
            background: rgba(255, 255, 255, 0.08);
            border: 1px solid rgba(255, 255, 255, 0.12);
        }

        /* Modal */
        .modal-backdrop {
            position: fixed;
            inset: 0;
            background: rgba(0, 0, 0, 0.55);
            display: none;
            align-items: center;
            justify-content: center;
            padding: 14px;
            z-index: 50;
        }

        .modal {
            width: min(720px, 95vw);
            background: #0f1630;
            border: 1px solid rgba(255, 255, 255, 0.14);
            border-radius: 16px;
            padding: 14px;
            box-shadow: 0 18px 60px rgba(0, 0, 0, 0.4);
        }

        .modal h3 {
            margin: 0 0 8px 0;
        }

        .modal .close-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            gap: 8px;
        }

        .modal .content {
            margin-top: 10px;
            line-height: 1.5;
            font-size: 14px;
        }

        .modal .list {
            margin: 10px 0 0 0;
            padding-left: 16px;
        }

        .modal .list li {
            margin: 6px 0;
        }

        .badge {
            font-size: 12px;
            padding: 4px 8px;
            border-radius: 999px;
            border: 1px solid rgba(255, 255, 255, 0.18);
            background: rgba(255, 255, 255, 0.08);
        }

        @media (max-width: 980px) {
            .grid {
                grid-template-columns: 1fr;
            }

            #chart {
                height: 440px;
            }
        }

        @media (max-width: 600px) {
            .wrap {
                padding: 12px;
            }

            /* Stack controls nicely and make them full-width */
            .topbar {
                gap: 10px;
            }

            .topbar .row {
                width: 100%;
            }

            #countrySelect, #speedSelect, #btnNextHighlight {
                width: 100%;
            }

            /* Bigger tap targets + prevent iOS zoom */
            select, button, input[type="range"] {
                font-size: 16px;
                padding: 12px 14px;
                border-radius: 14px;
            }

            #chart {
                height: 360px;
            }
        }

    </style>
</head>
<body>
<div class="wrap">
    <div class="close-row" style="display:flex; justify-content: space-between; align-items:center;">
        <div>
            <h2 style="margin: 0 0 4px 0;">COVID Policy Timeline Player</h2>
            <div class="mini">Interactive playback of reported COVID trends with policy change cards (OxCGRT). For
                education & storytelling, not causal inference.
            </div>
        </div>
        <button class="muted-btn" id="btnGlossary">What do these policies mean?</button>
    </div>

    <div class="topbar" style="margin-top: 12px;">
        <div class="row">
            <span class="pill">Country</span>
            <select id="countrySelect"></select>
        </div>

        <div class="row">
            <button id="btnPrev">‚èÆ</button>
            <button id="btnPlay">‚ñ∂</button>
            <button id="btnNext">‚è≠</button>

            <span class="pill">Speed</span>
            <select id="speedSelect">
                <option value="1">1√ó</option>
                <option value="4">4√ó</option>
                <option value="10">10√ó</option>
                <option value="30">30√ó</option>
            </select>
        </div>

        <div class="row">
            <label class="mini" sty:contentReference[oaicite:8]{index=8}gn-items:center; gap:8px;">
            <input id="showVax" type="checkbox" checked/>
            Show vaccination (% fully)
            </label>

            <label class="mini" style="display:flex; align-items:center; gap:8px;">
                <input id="autoPause" type="checkbox" checked/>
                Auto-pause on highlights
            </label>
            <button class="muted-btn" id="btnNextHighlight">Next highlight</button>
        </div>

        <div class="row" style="flex: 1; min-width: 260px;">
            <span class="pill" id="dateLabel">‚Äî</span>
            <input id="dateSlider" type="range" min="0" max="0" value="0" style="width: 100%;"/>
        </div>
    </div>

    <div class="grid">
        <div class="card">
            <div id="chart"></div>
            <div class="mini" id="disclaimer"></div>
        </div>

        <div class="card events">
            <div class="section-title">
                <div>Current policy status</div>
                <span class="badge" id="policyBadge">‚Äî</span>
            </div>
            <div id="policyStatus" class="mini" style="margin-bottom: 12px;"></div>

            <div class="section-title">
                <div>Policy / News Cards</div>
                <div class="mini">Auto-updates with date</div>
            </div>
            <div id="eventsContainer" style="margin-top: 10px;"></div>
            <hr style="border:0; border-top:1px solid rgba(255,255,255,0.12); margin:14px 0;">

            <div class="section-title">
                <div>Sources (Vancouver)</div>
                <div class="mini">Policy indicators + Stringency + case/death series</div>
            </div>

            <ol class="mini" style="padding-left: 18px; margin: 8px 0 0 0; line-height: 1.45;">
                <li>
                    Hale T, Angrist N, Goldszmidt R, et al. A global panel database of pandemic policies (Oxford
                    COVID-19 Government Response Tracker).
                    <i>Nat Hum Behav</i>. 2021;5:529‚Äì538. doi:10.1038/s41562-021-01079-8.
                </li>
                <li>
                    Oxford COVID-19 Government Response Tracker. Calculation and presentation of the Stringency Index
                    4.0 [Internet].
                    Oxford: Blavatnik School of Government, University of Oxford; 2020 Apr 28 [cited 2026 Jan 31].
                    Available from: <a
                        href="https://www.bsg.ox.ac.uk/sites/default/files/Calculation%20and%20presentation%20of%20the%20Stringency%20Index.pdf"
                        target="_blank" rel="noopener">https://www.bsg.ox.ac.uk/sites/default/files/Calculation%20and%20presentation%20of%20the%20Stringency%20Index.pdf</a>
                </li>
                <li>
                    Our World in Data. Data on COVID-19 (coronavirus) by Our World in Data: dataset documentation
                    [Internet].
                    Oxford: Our World in Data; [cited 2026 Jan 31].
                    Available from: <a href="https://docs.owid.io/projects/covid/en/latest/dataset.html" target="_blank"
                                       rel="noopener">https://docs.owid.io/projects/covid/en/latest/dataset.html</a>
                </li>
                <li>
                    Oxford COVID-19 Government Response Tracker. covid-policy-dataset [Internet].
                    GitHub; 2023 Jun 1 [cited 2026 Jan 31].
                    Available from: <a href="https://github.com/OxCGRT/covid-policy-dataset" target="_blank"
                                       rel="noopener">https://github.com/OxCGRT/covid-policy-dataset</a>
                </li>
            </ol>

        </div>
    </div>
</div>

<!-- Glossary Modal -->
<div class="modal-backdrop" id="glossaryBackdrop">
    <div class="modal">
        <div class="close-row">
            <h3 style="margin:0;">Policy glossary (plain language)</h3>
            <button class="muted-btn" id="btnCloseGlossary">Close</button>
        </div>
        <div class="content" id="glossaryContent"></div>
    </div>
</div>

<!-- Highlight Modal -->
<div class="modal-backdrop" id="highlightBackdrop">
    <div class="modal">
        <div class="close-row">
            <div style="display:flex; gap:8px; align-items:center;">
                <h3 style="margin:0;" id="hlTitle">Highlight</h3>
                <span class="badge" id="hlDate">‚Äî</span>
            </div>
            <button class="muted-btn" id="btnCloseHighlight">Close</button>
        </div>
        <div class="content" id="hlBody"></div>
        <div style="margin-top: 12px; display:flex; gap:10px; justify-content:flex-end;">
            <button class="muted-btn" id="btnResume">Resume</button>
        </div>
    </div>
</div>

<script>
    let chart = echarts.init(document.getElementById("chart"));

    let state = {
        dates: [],
        series: {},
        eventsByDate: new Map(),
        highlightsByDate: new Map(),
        meta: {policy_levels: {}, policy_labels: {}, stringency_explainer: ""},
        idx: 0,
        playing: false,
        timer: null,
        shownHighlights: new Set(),
    };

    function setPlaying(on) {
        state.playing = on;
        document.getElementById("btnPlay").textContent = on ? "‚è∏" : "‚ñ∂";
        if (state.timer) {
            clearInterval(state.timer);
            state.timer = null;
        }
        if (!on) return;

        const speed = parseInt(document.getElementById("speedSelect").value, 10);
        state.timer = setInterval(() => {
            step(1 * speed);
        }, 250);
    }

    function step(delta) {
        if (!state.dates.length) return;
        let next = state.idx + delta;
        if (next < 0) next = 0;
        if (next >= state.dates.length) next = state.dates.length - 1;
        state.idx = next;
        document.getElementById("dateSlider").value = String(state.idx);
        renderFrame(true);
    }

    function renderFrame(fromPlayback = false) {
        const d = state.dates[state.idx];
        document.getElementById("dateLabel").textContent = d || "‚Äî";

        const opt = buildOption();
        opt.series.forEach(s => {
            if (s.type === "line" && (
  s.name === "Cases (7d avg)":contentReference[oaicite:21]{index=21}vg)" ||
  s.name === "Stringency" ||
  s.name === "Fully vaccinated (%)"
)) {
  s.markLine = { symbol: ["none", "none"], data: [{ xAxis: d }] };
}
        });
        chart.setOption(opt, true);

        renderEvents(d);
        renderPolicyStatus(d);

        // Auto-pause on highlights
        const autoPause = document.getElementById("autoPause").checked;
        if (fromPlayback && state.playing && autoPause) {
            const highlights = state.highlightsByDate.get(d) || [];
            if (highlights.length) {
                const key = d + "::" + highlights.map(h => h.type + h.title).join("|");
                if (!state.shownHighlights.has(key)) {
                    state.shownHighlights.add(key);
                    setPlaying(false);
                    showHighlightModal(d, highlights);
                }
            }
        }
    }

    function renderEvents(dateStr) {
        const box = document.getElementById("eventsContainer");
        box.innerHTML = "";

        const items = state.eventsByDate.get(dateStr) || [];
        if (!items.length) {
            box.innerHTML = `<div class="mini">No policy-change card on this date.</div>`;
            return;
        }

        const card = document.createElement("div");
        card.className = "event-card";
        card.innerHTML = `<div class="event-date">${dateStr}</div>` + items.map(x => `<div class="event-item">‚Ä¢ ${escapeHtml(x)}</div>`).join("");
        box.appendChild(card);
    }

    function policyLevelText(key, val) {
        if (val === null || val === undefined) return "‚Äî";
        const levels = (state.meta.policy_levels || {})[key] || null;
        if (!levels) return String(val);
        const desc = levels[String(val)] ?? levels[val] ?? "Level";
        return `${val} (${desc})`;
    }

    function renderPolicyStatus(dateStr) {
        const s = state.series;
        const i = state.idx;
        const labels = state.meta.policy_labels || {};
        const badge = document.getElementById("policyBadge");
        const box = document.getElementById("policyStatus");

        const st = s.stringency?.[i];
        badge.textContent = (st !== null && st !== undefined) ? `Stringency: ${Number(st).toFixed(1)}` : "‚Äî";

        const lines = [];
        lines.push(`<div><b>Stringency</b>: ${(st !== null && st !== undefined) ? Number(st).toFixed(1) : "‚Äî"} <span class="mini">‚Äî ${escapeHtml(state.meta.stringency_explainer || "")}</span></div>`);
        lines.push(`<div>‚Ä¢ ${escapeHtml(labels.c1_school_closing || "School closing")} : ${escapeHtml(policyLevelText("c1_school_closing", s.school?.[i]))}</div>`);
        lines.push(`<div>‚Ä¢ ${escapeHtml(labels.c2_workplace_closing || "Workplace closing")} : ${escapeHtml(policyLevelText("c2_workplace_closing", s.work?.[i]))}</div>`);
        lines.push(`<div>‚Ä¢ ${escapeHtml(labels.c6_stay_at_home || "Stay-at-home")} : ${escapeHtml(policyLevelText("c6_stay_at_home", s.stayhome?.[i]))}</div>`);
        lines.push(`<div>‚Ä¢ ${escapeHtml(labels.c8_international_travel_controls || "Travel controls")} : ${escapeHtml(policyLevelText("c8_international_travel_controls", s.travel?.[i]))}</div>`);
        lines.push(`<div>‚Ä¢ ${escapeHtml(labels.h6_facial_coverings || "Face coverings")} : ${escapeHtml(policyLevelText("h6_facial_coverings", s.masks?.[i]))}</div>`);

        box.innerHTML = lines.join("");
    }

    function escapeHtml(str) {
        return String(str).replaceAll("&", "&amp;").replaceAll("<", "&lt;").replaceAll(">", "&gt;").replaceAll('"', "&quot;");
    }

    function buildOption() {
  const d = state.dates;
  const s = state.series;
  const showVax = document.:contentReference[oaicite:19]{index=19}cked ?? true;

  const yAxes = [
    { type: "value", axisLabel: { color: "#c9d2ff" }, name: "Cases/Deaths" },
    { type: "value", axisLabel: { color: "#c9d2ff" }, name: "Policy", min: 0, max: 100 },
  ];

  const series = [
    { name: "Cases (7d avg)", type: "line", yAxisIndex: 0, showSymbol: false, data: s.cases || [] },
    { name: "Deaths (7d avg)", type: "line", yAxisIndex: 0, showSymbol: false, data: s.deaths || [] },
    { name: "Stringency", type: "line", yAxisIndex: 1, showSymbol: false, data: s.stringency || [] },
  ];

  if (showVax) {
    yAxes.push({ type: "value", axisLabel: { color: "#c9d2ff" }, name: "Vaccination (%)", min: 0, max: 100 });
    series.push({
      name: "Fully vaccinated (%)",
      type: "line",
      yAxisIndex: 2,
      showSymbol: false,
      data: s.vax_full || [],
    });
  }

  return {
    animation: false,
    tooltip: {
      trigger: "axis",
      formatter: (params) => {
        const idx = params?.[0]?.dataIndex ?? state.idx;
        const dateStr = d[idx] || "‚Äî";
        const cases = s.cases?.[idx];
        const deaths = s.deaths?.[idx];
        const st = s.stringency?.[idx];
        const vax = s.vax_full?.[idx];

        const lines = [];
        lines.push(`<b>${escapeHtml(dateStr)}</b>`);
        lines.push(`Cases (7d avg): <b>${cases ?? "‚Äî"}</b>`);
        lines.push(`Deaths (7d avg): <b>${deaths ?? "‚Äî"}</b>`);
        lines.push(`Stringency: <b>${(st !== null && st !== undefined) ? Number(st).toFixed(1) : "‚Äî"}</b>`);
        if (showVax) lines.push(`Fully vaccinated (%): <b>${(vax !== null && vax !== undefined) ? Number(vax).toFixed(1) : "‚Äî"}</b>`);

        lines.push(`<div style="margin-top:6px; opacity:.9;"><b>Policy levels</b></div>`);
        lines.push(`School closing: ${escapeHtml(policyLevelText("c1_school_closing", s.school?.[idx]))}`);
        lines.push(`Stay-at-home: ${escapeHtml(policyLevelText("c6_stay_at_home", s.stayhome?.[idx]))}`);
        lines.push(`Intl travel: ${escapeHtml(policyLevelText("c8_international_travel_controls", s.travel?.[idx]))}`);
        lines.push(`Face coverings: ${escapeHtml(policyLevelText("h6_facial_coverings", s.masks?.[idx]))}`);

        return lines.join("<br/>");
      }
    },
    legend: { textStyle: { color: "#e8ecff" } },
    grid: { left: 40, right: 25, top: 45, bottom: 50 },
    xAxis: { type: "category", data: d, axisLabel: { color: "#c9d2ff" } },
    yAxis: yAxes,
    dataZoom: [{ type: "inside", start: 0, end: 100 }, { type: "slider", start: 0, end: 100 }],
    series: series,
  };
}

    async function loadCountries() {
        const res = await fetch("/api/countries/");
        const data = await res.json();
        const sel = document.getElementById("countrySelect");
        sel.innerHTML = "";

        const countries = data.countries || [];
        countries.sort((a, b) => {
            if (a.iso_code === "IDN") return -1;
            if (b.iso_code === "IDN") return 1;
            return a.name.localeCompare(b.name);
        });

        for (const c of countries) {
            const opt = document.createElement("option");
            opt.value = c.iso_code;
            opt.textContent = `${c.name} (${c.iso_code})`;
            sel.appendChild(opt);
        }

        sel.value = countries.find(x => x.iso_code === "IDN") ? "IDN" : (countries[0]?.iso_code || "");
    }

    async function loadSeries(iso) {
        setPlaying(false);
        const res = await fetch(`/api/timeseries/${encodeURIComponent(iso)}/`);
        const data = await res.json();

        state.dates = data.dates || [];
        state.series = data.series || {};
        state.meta = data.meta || {policy_levels: {}, policy_labels: {}, stringency_explainer: ""};

        state.eventsByDate = new Map();
        for (const ev of (data.events || [])) {
            state.eventsByDate.set(ev.date, ev.items || []);
        }

        state.highlightsByDate = new Map();
        for (const h of (data.highlights || [])) {
            if (!state.highlightsByDate.has(h.date)) state.highlightsByDate.set(h.date, []);
            state.highlightsByDate.get(h.date).push(h);
        }

        state.shownHighlights = new Set();
        state.idx = state.dates.length ? state.dates.length - 1 : 0;

        const slider = document.getElementById("dateSlider");
        slider.min = "0";
        slider.max = String(Math.max(0, state.dates.length - 1));
        slider.value = String(state.idx);

        document.getElementById("disclaimer").textContent = data.disclaimer || "";
        chart.setOption(buildOption(), true);
        renderFrame(false);
    }

    function showHighlightModal(dateStr, highlights) {
        const backdrop = document.getElementById("highlightBackdrop");
        document.getElementById("hlDate").textContent = dateStr;
        document.getElementById("hlTitle").textContent = "Highlight";

        const parts = [];
        const icon =
            h.type === "policy" ? "üìú" :
                (h.type === "cases" ? "üìà" :
                    (h.type === "deaths" ? "‚ö†Ô∏è" : "üíâ"));

        for (const h of highlights) {
            const icon = h.type === "policy" ? "üìú" : (h.type === "cases" ? "üìà" : "‚ö†Ô∏è");
            parts.push(`<div style="margin-bottom:10px;"><b>${icon} ${escapeHtml(h.title)}</b><ul class="list">${(h.details || []).map(x => `<li>${escapeHtml(x)}</li>`).join("")}</ul></div>`);
        }
        document.getElementById("hlBody").innerHTML = parts.join("");

        backdrop.style.display = "flex";
    }

    function closeHighlightModal() {
        document.getElementById("highlightBackdrop").style.display = "none";
    }

    function openGlossary() {
        const b = document.getElementById("glossaryBackdrop");
        const levels = state.meta.policy_levels || {};
        const labels = state.meta.policy_labels || {};
        const blocks = [];

        blocks.push(`<div class="mini"><b>Stringency</b>: ${escapeHtml(state.meta.stringency_explainer || "")}</div>`);
        blocks.push(`<hr style="border:0; border-top:1px solid rgba(255,255,255,0.12); margin:12px 0;">`);

        function renderLevels(key) {
            const map = levels[key] || {};
            const items = Object.keys(map).sort((a, b) => Number(a) - Number(b)).map(k => `<li><b>${k}</b>: ${escapeHtml(map[k])}</li>`).join("");
            return `<div style="margin-bottom:12px;"><b>${escapeHtml(labels[key] || key)}</b><ul class="list">${items}</ul></div>`;
        }

        blocks.push(renderLevels("c1_school_closing"));
        blocks.push(renderLevels("c2_workplace_closing"));
        blocks.push(renderLevels("c6_stay_at_home"));
        blocks.push(renderLevels("c8_international_travel_controls"));
        blocks.push(renderLevels("h6_facial_coverings"));
        blocks.push(`<div class="mini">Reminder: these indices describe reported policy strictness, not compliance or effectiveness.</div>`);

        document.getElementById("glossaryContent").innerHTML = blocks.join("");
        b.style.display = "flex";
    }

    function closeGlossary() {
        document.getElementById("glossaryBackdrop").style.display = "none";
    }

    function jumpToNextHighlight() {
        if (!state.dates.length) return;
        for (let j = state.idx + 1; j < state.dates.length; j++) {
            const d = state.dates[j];
            if ((state.highlightsByDate.get(d) || []).length) {
                state.idx = j;
                document.getElementById("dateSlider").value = String(state.idx);
                renderFrame(false);
                showHighlightModal(d, state.highlightsByDate.get(d));
                return;
            }
        }
        alert("No more highlights ahead for this country.");
    }

    document.getElementById("btnPlay").addEventListener("click", () => setPlaying(!state.playing));
    document.getElementById("btnPrev").addEventListener("click", () => {
        setPlaying(false);
        step(-1);
    });
    document.getElementById("btnNext").addEventListener("click", () => {
        setPlaying(false);
        step(1);
    });
    document.getElementById("speedSelect").addEventListener("change", () => {
        if (state.playing) setPlaying(true);
    });

    document.getElementById("dateSlider").addEventListener("input", (e) => {
        setPlaying(false);
        state.idx = parseInt(e.target.value, 10) || 0;
        renderFrame(false);
    });

    document.getElementById("countrySelect").addEventListener("change", (e) => {
        loadSeries(e.target.value);
    });

    document.getElementById("btnGlossary").addEventListener("click", openGlossary);
    document.getElementById("btnCloseGlossary").addEventListener("click", closeGlossary);
    document.getElementById("glossaryBackdrop").addEventListener("click", (e) => {
        if (e.target.id === "glossaryBackdrop") closeGlossary();
    });

    document.getElementById("btnNextHighlight").addEventListener("click", () => {
        setPlaying(false);
        jumpToNextHighlight();
    });

    document.getElementById("btnCloseHighlight").addEventListener("click", closeHighlightModal);
    document.getElementById("btnResume").addEventListener("click", () => {
        closeHighlightModal();
        setPlaying(true);
    });
    document.getElementById("highlightBackdrop").addEventListener("click", (e) => {
        if (e.target.id === "highlightBackdrop") closeHighlightModal();
    });

    (async function init() {
        await loadCountries();
        const iso = document.getElementById("countrySelect").value;
        if (iso) await loadSeries(iso);
    })();
</script>
</body>
</html>
